#N canvas 511 96 735 834 10;
#X obj 176 44 inlet;
#X obj 378 714 outlet;
#X obj 378 135 openpanel;
#X obj 176 70 route float;
#X obj 378 114 route bang;
#X obj 435 156 symbol;
#X obj 378 86 route open display;
#X obj 195 156 until;
#X obj 195 177 f;
#X obj 222 354 list;
#X obj 195 291 <=;
#X obj 288 328 f;
#X obj 195 312 sel;
#X obj 261 328 b;
#X obj 314 328 max;
#N canvas 1155 168 357 344 time_direction_forward 0;
#X obj 39 41 inlet;
#X obj 39 274 outlet;
#X obj 39 110 t a a a, f 17;
#X obj 136 214 -;
#X obj 138 162 change;
#X obj 39 89 change;
#X obj 136 274 outlet;
#X text 38 292 readhead time;
#X text 136 292 direction;
#X obj 229 274 outlet;
#X obj 138 183 t a a a;
#X text 226 292 forward;
#X obj 138 141 > -1;
#X connect 0 0 5 0;
#X connect 2 0 1 0;
#X connect 2 1 12 1;
#X connect 2 2 12 0;
#X connect 3 0 6 0;
#X connect 4 0 10 0;
#X connect 5 0 2 0;
#X connect 10 0 3 1;
#X connect 10 1 3 0;
#X connect 10 2 9 0;
#X connect 12 0 4 0;
#X restore 176 114 pd time_direction_forward;
#N canvas 281 78 763 800 prepare_scratchable_arrays 0;
#X obj 345 730 outlet;
#X msg 92 115 save temp.midi.txt;
#X msg 75 167 read temp.midi.txt;
#X msg 211 115 open \$1;
#X obj 92 136 else/midi;
#X obj 75 188 text define \$0-midi;
#X obj 58 52 inlet;
#X obj 200 582 array set \$0-pitch;
#X obj 173 645 array set \$0-duration;
#X obj 154 666 array set \$0-velocity;
#X obj 488 404 s \$0-notes-end;
#X msg 488 383 const \$1;
#X obj 58 320 until;
#X obj 58 299 f;
#X obj 58 341 f;
#X obj 85 341 - 1;
#X obj 97 320 - 1;
#X obj 58 362 text get \$0-scratchable;
#X obj 173 603 array get \$0-notes-end 0 1;
#X obj 58 259 t b b;
#X obj 97 283 f;
#X obj 223 561 array set \$0-time;
#X obj 58 404 > 0;
#X obj 58 383 t f a a, f 20;
#X obj 58 476 list;
#X obj 154 476 list;
#X obj 58 425 sel 0 1;
#X obj 58 666 unpack f f f;
#X obj 92 708 array set \$0-notes-end 0 1;
#X obj 92 687 swap;
#X obj 154 540 unpack f f f;
#X obj 181 518 f;
#X obj 207 518 - 1;
#X obj 173 561 t f f;
#X obj 173 624 -;
#X obj 154 497 t a b;
#X msg 345 453 size \$1;
#X msg 461 450 duration \$1;
#X obj 193 497 - 1;
#X obj 372 516 array define \$0-pitch;
#X msg 372 474 resize \$1;
#X obj 372 495 array define \$0-time;
#X obj 372 558 array define \$0-duration;
#X obj 372 537 array define \$0-velocity;
#X text 215 159 first convert to format with absolute timestamps;
#X text 215 179 then count notes of channel 1 with velocity > 0;
#X text 215 199 then read backwards through the absolute timestamps and save note-on with according duration. reset note-end timestamp for that pitch;
#X obj 92 729 array define \$0-notes-end 128;
#X obj 58 83 t b b b s;
#X text 351 284 note-on count;
#X text 464 285 duration;
#N canvas 1042 289 516 622 parse_midi_and_fill_scratchable_text 0;
#X obj 20 20 inlet;
#X obj 366 569 outlet;
#X msg 128 81 line 0 \, auto;
#X msg 143 102 0;
#X obj 128 295 +;
#X obj 155 295 f;
#X obj 128 173 list split 1;
#X obj 162 194 list split 1;
#X msg 268 152 clear;
#X msg 173 428 1e+09;
#X text 70 294 sum time;
#X obj 101 217 f;
#X text 154 239 <-- currently only considers midi channel 1;
#X obj 101 195 t b f;
#X obj 101 238 sel 144;
#X obj 101 338 f;
#X obj 268 173 text define \$0-scratchable;
#X obj 101 450 text insert \$0-scratchable;
#X obj 128 152 text sequence \$0-midi;
#X obj 101 259 t b b;
#X obj 184 275 list;
#X obj 289 402 f;
#X obj 316 402 + 1;
#X obj 289 380 b;
#X obj 217 337 unpack;
#X obj 250 358 moses 1;
#X msg 316 381 1;
#X msg 188 102 1;
#X obj 184 337 swap;
#X obj 101 401 list prepend;
#X obj 184 358 pack;
#X obj 184 306 t a a;
#X obj 113 60 t b b b b b b;
#X text 243 568 note-on count;
#X text 410 568 duration;
#X obj 31 569 outlet;
#X obj 366 548 f;
#X obj 199 548 f;
#X obj 199 569 outlet;
#X text 76 568 note count;
#X obj 31 454 t b b b;
#X obj 31 548 text size \$0-scratchable;
#X connect 0 0 32 0;
#X connect 2 0 18 0;
#X connect 3 0 4 1;
#X connect 4 0 5 0;
#X connect 4 0 15 1;
#X connect 5 0 4 1;
#X connect 6 0 13 0;
#X connect 6 1 7 0;
#X connect 7 0 11 1;
#X connect 7 1 20 1;
#X connect 8 0 16 0;
#X connect 9 0 17 1;
#X connect 11 0 14 0;
#X connect 13 0 11 0;
#X connect 13 1 4 0;
#X connect 14 0 19 0;
#X connect 15 0 29 0;
#X connect 15 0 36 1;
#X connect 18 0 6 0;
#X connect 19 0 15 0;
#X connect 19 1 20 0;
#X connect 20 0 31 0;
#X connect 21 0 22 0;
#X connect 21 0 37 1;
#X connect 22 0 21 1;
#X connect 23 0 21 0;
#X connect 24 1 25 0;
#X connect 25 1 23 0;
#X connect 26 0 21 1;
#X connect 27 0 26 0;
#X connect 28 0 30 0;
#X connect 28 1 30 1;
#X connect 29 0 17 0;
#X connect 30 0 29 1;
#X connect 31 0 28 0;
#X connect 31 1 24 0;
#X connect 32 0 40 0;
#X connect 32 1 2 0;
#X connect 32 2 3 0;
#X connect 32 3 27 0;
#X connect 32 4 9 0;
#X connect 32 5 8 0;
#X connect 36 0 1 0;
#X connect 37 0 38 0;
#X connect 40 0 41 0;
#X connect 40 1 37 0;
#X connect 40 2 36 0;
#X connect 41 0 35 0;
#X restore 230 267 pd parse_midi_and_fill_scratchable_text;
#X text 231 284 note count;
#X obj 461 341 t f f;
#X obj 345 341 t f f;
#X text 199 624 calculate duration;
#X obj 58 220 t b b;
#X text 62 457 note-offs;
#X text 156 457 note-ons;
#X obj 488 362 + 1000;
#X text 534 363 sustain last open notes for 1s;
#X connect 1 0 4 0;
#X connect 2 0 5 0;
#X connect 3 0 4 0;
#X connect 6 0 48 0;
#X connect 11 0 10 0;
#X connect 12 0 14 0;
#X connect 13 0 12 0;
#X connect 14 0 15 0;
#X connect 14 0 17 0;
#X connect 15 0 14 1;
#X connect 16 0 14 1;
#X connect 17 0 23 0;
#X connect 18 0 34 0;
#X connect 19 0 13 0;
#X connect 19 1 20 0;
#X connect 20 0 13 1;
#X connect 20 0 16 0;
#X connect 22 0 26 0;
#X connect 23 0 22 0;
#X connect 23 1 24 1;
#X connect 23 2 25 1;
#X connect 24 0 27 0;
#X connect 25 0 35 0;
#X connect 25 0 27 0;
#X connect 26 0 24 0;
#X connect 26 1 25 0;
#X connect 27 1 29 0;
#X connect 27 2 29 1;
#X connect 29 0 28 0;
#X connect 29 1 28 1;
#X connect 30 0 9 0;
#X connect 30 1 33 0;
#X connect 30 2 21 0;
#X connect 30 2 34 1;
#X connect 31 0 32 0;
#X connect 31 0 21 1;
#X connect 31 0 7 1;
#X connect 31 0 8 1;
#X connect 31 0 9 1;
#X connect 32 0 31 1;
#X connect 33 0 18 0;
#X connect 33 1 7 0;
#X connect 34 0 8 0;
#X connect 35 0 30 0;
#X connect 35 1 31 0;
#X connect 36 0 0 0;
#X connect 37 0 0 0;
#X connect 38 0 31 1;
#X connect 40 0 39 0;
#X connect 40 0 41 0;
#X connect 40 0 42 0;
#X connect 40 0 43 0;
#X connect 48 0 56 0;
#X connect 48 1 2 0;
#X connect 48 2 1 0;
#X connect 48 3 3 0;
#X connect 51 0 20 1;
#X connect 51 1 38 0;
#X connect 51 1 54 0;
#X connect 51 2 53 0;
#X connect 53 0 37 0;
#X connect 53 1 59 0;
#X connect 54 0 36 0;
#X connect 54 1 40 0;
#X connect 56 0 19 0;
#X connect 56 1 51 0;
#X connect 59 0 11 0;
#X restore 378 191 pd prepare_scratchable_arrays;
#X obj 176 135 t b b a b, f 10;
#X obj 203 714 outlet;
#X obj 314 161 t b a;
#X obj 176 582 f;
#X obj 176 603 t f f;
#X obj 203 666 swap;
#X obj 176 645 moses;
#X msg 432 323 const -1;
#X obj 222 177 + -1;
#X obj 195 198 t a a a;
#X obj 323 203 ==;
#X obj 195 219 -;
#X obj 387 455 max;
#X obj 387 416 t f f;
#X obj 443 455 min;
#X msg 433 416 0;
#X msg 471 416 128;
#X obj 387 503 -;
#X obj 443 476 t b f;
#X obj 414 455 f;
#X obj 471 455 f;
#X obj 387 524 + 1;
#X obj 203 583 + 1;
#X obj 176 561 until;
#X obj 176 540 f;
#X obj 176 455 spigot 0;
#X msg 195 354 1;
#X text 22 454 output if values present;
#X text 496 454 determine lowest and highest pitch;
#X obj 457 620 array define \$0-play-duration 128;
#X obj 195 333 t b b;
#X obj 215 417 array set \$0-play-duration;
#X obj 203 687 pack f f f;
#X obj 222 375 unpack f f f;
#X obj 260 666 array get \$0-play-duration 0 1;
#X obj 195 396 array set \$0-play-velocity;
#X obj 457 599 array define \$0-play-velocity 128;
#X obj 432 374 s \$0-play-velocity;
#X obj 549 374 s \$0-play-duration;
#X obj 176 624 array get \$0-play-velocity 0 1;
#N canvas 1063 253 356 475 get_values_from_scratchable_arrays 0;
#X obj 55 236 array get \$0-time 0 1;
#X obj 55 38 inlet;
#X obj 55 199 t f f f f;
#X obj 158 38 inlet;
#X obj 158 119 route size;
#X obj 55 115 moses 0;
#X obj 94 135 moses;
#X obj 245 397 outlet;
#X obj 55 397 outlet;
#X text 57 416 time;
#X obj 148 397 outlet;
#X text 248 416 bang;
#X obj 111 167 b;
#X obj 85 343 pack f f f;
#X obj 85 260 array get \$0-velocity 0 1;
#X obj 113 281 array get \$0-duration 0 1;
#X obj 142 302 array get \$0-pitch 0 1;
#X text 150 416 note;
#X connect 0 0 8 0;
#X connect 1 0 5 0;
#X connect 2 0 0 0;
#X connect 2 1 14 0;
#X connect 2 2 15 0;
#X connect 2 3 16 0;
#X connect 3 0 4 0;
#X connect 4 0 6 1;
#X connect 5 0 12 0;
#X connect 5 1 6 0;
#X connect 6 0 2 0;
#X connect 6 1 12 0;
#X connect 12 0 7 0;
#X connect 13 0 10 0;
#X connect 14 0 13 0;
#X connect 15 0 13 1;
#X connect 16 0 13 2;
#X restore 195 250 pd get_values_from_scratchable_arrays;
#X text 56 593 output filtered notes (from lowest to highest present pitch), f 18;
#X obj 432 302 t b b b;
#X text 572 718 Ben Wesch \, 2024;
#X text 56 754 would be much simpler without the filtering and a bit more efficient (outputting directly from [list]). but then \, the amount of midi events might become a problem?;
#X connect 0 0 3 0;
#X connect 2 0 16 0;
#X connect 3 0 15 0;
#X connect 3 1 6 0;
#X connect 4 0 2 0;
#X connect 4 1 5 0;
#X connect 5 0 16 0;
#X connect 6 0 4 0;
#X connect 7 0 8 0;
#X connect 8 0 26 0;
#X connect 9 0 50 0;
#X connect 10 0 12 0;
#X connect 11 0 14 0;
#X connect 12 0 47 0;
#X connect 12 1 13 0;
#X connect 13 0 11 0;
#X connect 14 0 19 0;
#X connect 15 0 17 0;
#X connect 15 1 25 1;
#X connect 15 2 12 1;
#X connect 15 2 27 0;
#X connect 16 0 1 0;
#X connect 16 0 57 1;
#X connect 17 0 42 0;
#X connect 17 1 7 0;
#X connect 17 2 10 1;
#X connect 17 3 59 0;
#X connect 19 0 7 1;
#X connect 19 1 8 1;
#X connect 20 0 21 0;
#X connect 20 0 39 0;
#X connect 21 0 56 0;
#X connect 21 1 51 0;
#X connect 21 1 22 1;
#X connect 22 0 49 0;
#X connect 22 1 49 1;
#X connect 23 1 22 0;
#X connect 24 0 54 0;
#X connect 24 0 55 0;
#X connect 25 0 8 1;
#X connect 26 0 28 0;
#X connect 26 1 11 1;
#X connect 26 2 25 0;
#X connect 27 0 28 1;
#X connect 28 0 57 0;
#X connect 29 0 34 0;
#X connect 29 0 36 0;
#X connect 30 0 29 0;
#X connect 30 1 31 0;
#X connect 31 0 35 0;
#X connect 31 0 37 0;
#X connect 31 0 20 1;
#X connect 32 0 36 0;
#X connect 32 0 42 1;
#X connect 33 0 37 0;
#X connect 34 0 38 0;
#X connect 35 0 34 0;
#X connect 35 1 34 1;
#X connect 36 0 29 1;
#X connect 37 0 31 1;
#X connect 38 0 41 1;
#X connect 39 0 20 1;
#X connect 40 0 20 0;
#X connect 41 0 40 0;
#X connect 42 0 41 0;
#X connect 43 0 42 1;
#X connect 47 0 43 0;
#X connect 47 1 9 0;
#X connect 49 0 18 0;
#X connect 50 0 52 0;
#X connect 50 1 48 0;
#X connect 50 2 48 1;
#X connect 50 2 30 0;
#X connect 50 2 52 1;
#X connect 51 0 49 2;
#X connect 56 0 23 0;
#X connect 57 0 10 0;
#X connect 57 1 9 1;
#X connect 57 2 11 0;
#X connect 59 0 24 0;
#X connect 59 1 32 0;
#X connect 59 2 33 0;
